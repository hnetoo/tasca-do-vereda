# AGT Technical Architecture & Compliance Manual - REST IA

**Version:** 1.1 (AGT Certification Ready)
**Date:** 2026-02-07
**Lead Engineer:** Helder Neto

---

## 1. System Architecture Overview
The "REST IA" system implements a hybrid Offline-First architecture with real-time synchronization, engineered to guarantee 99.99% availability and full compliance with Angolan Tax Authority (AGT) requirements.

### 1.1. Technology Stack
*   **Frontend:** React + TypeScript + Vite (Ultra-Performance)
*   **Local Storage:** SQLite (Native) / IndexedDB (Web)
*   **Cloud Backend:** Supabase (PostgreSQL + Realtime)
*   **Security:** AES-GCM 256-bit + RSASSA-PKCS1-v1_5 (RSA-SHA256)
*   **Monitoring:** Custom Heuristic System Health Engine

## 2. AGT Compliance Implementation

### 2.1. Sequential Document Hashing (Chain of Integrity)
In accordance with AGT regulations, every fiscal document generated by the system is linked to the previous one:
*   **Algorithm:** SHA-256
*   **Chaining:** Each invoice payload includes the `previousHash` (Signature part of the previous document's JWS).
*   **Immutability:** Any tampering with a single document invalidates the entire subsequent chain, detectable by the AGT Audit Dashboard.
*   **Hash Seed:** The initial document (Zero Invoice) uses a seed hash defined during system initialization.

### 2.2. Digital Signature (JWS - JSON Web Signature)
The system uses the `RS256` (RSA-SHA256) algorithm for document signing:
*   **Format:** JWS (RFC 7515)
*   **Header:** `{"typ":"JOSE", "alg":"RS256"}`
*   **Payload:** Includes critical data points: `documentNo`, `taxRegistrationNumber`, `documentDate`, `customerTaxID`, `previousHash`, and `documentTotals`.
*   **Key Management:** 2048-bit RSA keys, with the private key stored in a secure, encrypted local environment.

### 2.3. SAF-T AO (v1.2) Export & Simulation
The system provides advanced auditing tools:
*   **Real-time Simulation:** The `simulateSaftExportAndValidateChaining` tool allows auditors to verify the integrity of the entire document chain in milliseconds.
*   **Data Coverage:** Full alignment with the AGT SAF-T AO schema, covering Master Files (Customers, Products) and Transactional Data (Sales Invoices, Payments).
*   **Validation:** Automated schema validation against AGT XSD definitions before export.

### 2.4. Fiscal Document Types Supported
*   **FT (Factura):** Standard invoice.
*   **FR (Factura/Recibo):** Invoice/Receipt for immediate payment.
*   **NC (Nota de Crédito):** Credit note for corrections.
*   **ND (Nota de Débito):** Debit note for adjustments.

## 3. NASA-Grade Stability & Resilience

### 3.1. Triple Redundancy Storage (TRS)
Ensuring zero data loss for financial records:
1.  **Primary (L1):** High-speed SQLite/IndexedDB operations.
2.  **Local Fallback (L2):** Mirroring to LocalStorage for instant recovery from DB corruption.
3.  **Cloud Sync (L3):** Asynchronous Supabase synchronization with `AbortController` timeout management.

### 3.2. ML-Style Failure Prediction
The `healthMonitorService.ts` analyzes performance patterns:
*   **MTBF (Mean Time Between Failures):** Real-time calculation of system reliability.
*   **Latency Spikes:** Proactive alerts when network or DB latency exceeds 200ms.
*   **Self-Healing:** Automatic detection and resolution of synchronization conflicts.

## 4. Security Operations Center (SOC)
The `SystemHealth.tsx` dashboard provides real-time oversight:
*   **Compliance Score:** Real-time audit of AGT requirements.
*   **PITR (Point-in-Time Recovery):** Instant state restoration using AES-GCM encrypted snapshots.
*   **DLP (Data Loss Prevention):** Active checksum validation for all financial entities.

## 5. Certification Procedures

### 5.1. Initial Setup
1.  Generate RSA Key Pair via `agtService.ts`.
2.  Register the Software Validation Number (assigned by AGT).
3.  Perform the first "Zero Invoice" to establish the hash chain.

### 5.2. Daily Operations
*   The system automatically signs and chains every transaction.
*   Periodic SAF-T AO backups are generated and encrypted.
*   Real-time monitoring ensures the hash chain remains unbroken.

---
*This manual documents the technical innovations that place "REST IA" at the forefront of fiscal software excellence in Angola.*
